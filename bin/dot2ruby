#!/usr/bin/env ruby
# Copyright (C) 2010 Gregoire Lejeune <gregoire.lejeune@free.fr>
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
# 
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307  USA

require 'rubygems'
require 'graphviz/constants'
require 'graphviz/ext'
require 'graphviz/utils'
require 'getoptlong'

class Dot2Ruby
  include GVUtils
  
  def initialize( xGVPath, xUse, xOutFile )
    paths = (xGVPath.nil?) ? [] : [xGVPath]
    @xUsePath = find_executable( xUse, paths )
    @xGvprPath = find_executable( 'gvpr', paths )
    @xOutFile = xOutFile
    @gvprScript = GraphViz::Ext.find( "dot2ruby.g" )
  end
  
  def run( xFile )
    xCmd = "#{@xUsePath} #{xFile} | #{@xGvprPath} -f #{@gvprScript}"
    xOutput = output_from_command( xCmd )
    if @xOutFile.nil?
      puts xOutput
    else
      File.open( @xOutFile, "w" ) do |io|
        io.print xOutput
      end
    end 
  end
end

def usage 
  puts "usage: dot2ruby [-ofile] [-h] [-V] script"
  puts "-o, --output-file file        Output file (default: STDOUT)"
  puts "-p, --path                    Graphviz path"
  puts "-u, --use PROGRAM             Program to use (default: dot)"
  puts "-V, --version                 Show version"
  puts "-h, --help                    Show this usage message"
end

def version
  puts "Dot2Ruby v#{Constants::RGV_VERSION}, (c) 2010 Gregoire Lejeune <gregoire.lejeune@free.fr>"
  puts ""
  puts "This program is free software; you can redistribute it and/or modify"
  puts "it under the terms of the GNU General Public License as published by"
  puts "the Free Software Foundation; either version 2 of the License, or"
  puts "(at your option) any later version."
  puts ""
  puts "This program is distributed in the hope that it will be useful,"
  puts "but WITHOUT ANY WARRANTY; without even the implied warranty of"
  puts "MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the"
  puts "GNU General Public License for more details."
  puts ""
  puts "You should have received a copy of the GNU General Public License"
  puts "along with this program; if not, write to the Free Software"
  puts "Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307  USA"
end

xOutFile = nil
xGVPath = nil
xUse = "dot"

oOpt = GetoptLong.new(
  ['--output-file',   '-o', GetoptLong::REQUIRED_ARGUMENT],
  ['--path',          '-p', GetoptLong::REQUIRED_ARGUMENT],
  ['--use',           '-u', GetoptLong::REQUIRED_ARGUMENT],
  ['--help',          '-h', GetoptLong::NO_ARGUMENT],
  ['--version',       '-V', GetoptLong::NO_ARGUMENT]
)

begin
  oOpt.each_option do |xOpt, xValue|
    case xOpt
      when '--output-file'
        xOutFile = xValue
      when '--path'
        xGVPath = xValue
      when '--use'
        xUse = xValue
      when '--help'
        usage( )
        exit
      when '--version'
        version( )
        exit
    end
  end
rescue GetoptLong::InvalidOption => e
  usage( )
  exit
end

xFile = ARGV[0]

if xFile.nil? == true
  usage( )
  exit
end

Dot2Ruby::new( xGVPath, xUse, xOutFile ).run( xFile )
